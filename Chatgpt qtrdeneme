#include <QTRSensors.h>

// L298N motor driver için motor pin tanımlamaları
#define rightMotor1 5
#define rightMotor2 18
#define leftMotor1 17
#define leftMotor2 16

// ESP32 üzerindeki LED pin tanımlamaları
#define LED_PIN 2 // Örnek olarak GPIO 2 pinini kullanıyoruz

QTRSensors qtr((unsigned char[]) {34, 39, 36, 0, 2, 15}, 6); // QTR sensörleri için pinler

const int THRESHOLD = 800; // Eşik değer

void setup() {
  Serial.begin(115200); // Seri iletişim başlatılıyor

  // Motor pinleri çıkış olarak ayarlanıyor
  pinMode(rightMotor1, OUTPUT);
  pinMode(rightMotor2, OUTPUT);
  pinMode(leftMotor1, OUTPUT);
  pinMode(leftMotor2, OUTPUT);

  // LED pinini çıkış olarak ayarla ve kapat
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);

  // Kalibrasyon fazı başlatılıyor
  for (int calibrateStep = 0; calibrateStep < 2; calibrateStep++) {
    for (int i = 0; i < 50; i++) {
      if (calibrateStep == 0) {
        // İlk adımda sağa dön
        analogWrite(rightMotor1, 0);
        analogWrite(rightMotor2, 100);
        analogWrite(leftMotor1, 100);
        analogWrite(leftMotor2, 0);
      } else {
        // İkinci adımda sola dön
        analogWrite(rightMotor1, 100);
        analogWrite(rightMotor2, 0);
        analogWrite(leftMotor1, 0);
        analogWrite(leftMotor2, 100);
      }

      qtr.calibrate();

      // LED'i yanıp söndür
      digitalWrite(LED_PIN, HIGH);
      delay(100);
      digitalWrite(LED_PIN, LOW);
      delay(100);
    }
  }

  // Kalibrasyon sonrası robotu durdur
  analogWrite(rightMotor1, 0);
  analogWrite(rightMotor2, 0);
  analogWrite(leftMotor1, 0);
  analogWrite(leftMotor2, 0);
}

void loop() {
  uint32_t output = 0; // Çıkış verisi için 32-bitlik bir değişken oluşturuluyor

  // Sensörlerden değerler okunuyor ve çıkış verisi oluşturuluyor
  for (int i = 0; i < qtr.numSensors(); i++) {
    output <<= 1; // Bir önceki çıkışı sola kaydır
    output |= (qtr.readLine()[i] > THRESHOLD) ? 1 : 0; // Sensör değerini oku ve biti ayarla
  }

  // Çıkış verisini yan yana boşluklarla seri monitöre yazdır
  for (int i = qtr.numSensors() - 1; i >= 0; i--) {
    Serial.print((output >> i) & 1);
    Serial.print(" ");
  }
  Serial.println(); // Satır sonu

  delay(100); // 100 milisaniye bekletme
}
